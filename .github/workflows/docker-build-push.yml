name: docker-build-push
on:
  push:
    branches:
      - gce-deploy # for testing purposes

env:
  PROJECT_ID: ${{ secrets.GCE_PROJECT }}
  GCE_INSTANCE: deploy-pudl-vm # TODO: update to instance name
  GCE_INSTANCE_ZONE: us-central1-a # TODO: update to instance zone

jobs:
  push_to_registry:
    name: Build Docker image and push to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

  #     - name: Docker Metadata
  #       id: docker_metadata
  #       uses: docker/metadata-action@v3.8.0
  #       with:
  #         images: catalystcoop/pudl-etl
  #         flavor: |
  #           latest=auto
  #         tags: |
  #           type=ref,event=branch
  #           type=ref,event=tag

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v1.7.0

  #     - name: Login to DockerHub
  #       if: github.event_name != 'pull_request'
  #       uses: docker/login-action@v1.14.1
  #       with:
  #         username: ${{ secrets.DOCKERHUB_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}

  #     - name: Build image and push to Docker Hub
  #       uses: docker/build-push-action@v2.10.0
  #       with:
  #         context: .
  #         file: docker/Dockerfile
  #         push: ${{ github.event_name != 'pull_request' }}
  #         tags: ${{ steps.docker_metadata.outputs.tags }}
  #         labels: ${{ steps.docker_metadata.outputs.labels }}

  deploy_to_gce:
    name: Deploy the image to a GCE VM
    runs-on: ubuntu-latest
    needs: push_to_registry
    steps:
      # Setup gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      # Authentication via credentials json
      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with:
          credentials_json: "${{ secrets.GCE_SA_KEY }}"
      # Change docker tab to steps.docker_metadata.outputs.tags
      - name: Deploy
        run: |-
          gcloud compute instances update-container "$GCE_INSTANCE" \
            --zone "$GCE_INSTANCE_ZONE" \
            --container-image "docker.io/catalystcoop/pudl-etl:gce-deploy"
